# geojb
# Search locations
source src_geojb_locations : def_pgsql
{
    sql_db = sit_${db_staging}
}

source src_geojb_communes : src_geojb_locations
{
    sql_attr_bigint = commune_gid
    sql_attr_string = label
    sql_attr_uint = rank
    sql_attr_string = origin
    sql_attr_string = geom_st_box2d
    sql_field_string = ofs
    sql_field_string = ofs_arr
    sql_field_string = detail
    sql_query = \
        SELECT \
            commune_gid::bigint \
	    , commune_gid \
            , '<b>'||commune_nom||'</b>' as label \
            , 10 as rank \
            , 'communes' as origin \
            , box2d(the_geom) as geom_st_box2d \
            , cast(commune_ofs as text) as ofs \
            , cast(commune_ofs_arr as text) as ofs_arr \
            , remove_accents(commune_nom) as detail \
        from \
            communes
}

source src_geojb_streets : src_geojb_locations
{
    sql_attr_bigint = nomderue_id
    sql_attr_string = label
    sql_attr_uint = rank
    sql_attr_string = origin
    sql_attr_string = geom_st_box2d
    sql_attr_string = commune
    sql_attr_string = street
    sql_attr_uint = num
    sql_field_string = ofs
    sql_field_string = ofs_arr
    sql_field_string = detail
    sql_query = \
        SELECT \
	    nomderue_gid::bigint \
	    , cast(nomderue_id as bigint) as nomderue_id \
       	    , nomderue_id \
            , '<b>' || nomderue_commune || ', ' || nomderue_strassenname || ', ' || nomderue_strassennummer || '</b>' as label \
            , 20 as rank \
            , 'nomderue' as origin \
            , box2d(the_geom) as geom_st_box2d \
            , nomderue_commune as commune \
            , nomderue_strassenname as street \
            , nomderue_strassennummer as num \
            , cast(nomderue_ofs as text) as ofs \
            , cast(nomderue_arrondissement as text) as ofs_arr \
            , remove_accents(nomderue_commune || ', ' || nomderue_strassenname || ', ' || nomderue_strassennummer) as detail \
        from \
            nomderue
}

index geojb_communes
{
    type = plain
    docinfo = extern
    min_infix_len = 2
    source = src_geojb_communes
    path = /var/lib/sphinx/data/index/geojb_communes
}

index geojb_streets
{
    type = plain
    docinfo = extern
    min_infix_len = 2
    source = src_geojb_streets
    path = /var/lib/sphinx/data/index/geojb_streets
}

index geojb_locations
{
    type = distributed
    local = geojb_communes
    local = geojb_streets
}
